// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

datasource db {
    provider = "sqlite"
    url      = "file:./dev.db"
}

enum UserType {
    CONTRACTOR
    HOMEOWNER
}

model User {
    id       Int      @id @default(autoincrement())
    username String   @unique
    name     String
    type     UserType

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    jobsAsHomeowner Job[]            @relation("JobHomeowners")
    jobsCreated     Job[]            @relation("JobCreatedBy")
    jobsDeleted     Job[]            @relation("JobDeletedBy")
    messagesCreated JobChatMessage[] @relation("JobChatMessageCreatedBy")
    tasksCompleted  JobTask[]        @relation("JobTaskCompletedBy")
}

enum JobStatus {
    IN_PROGRESS
    PLANNING
    COMPLETED
    CANCELED
}

model Job {
    id          Int       @id @default(autoincrement())
    description String
    location    String
    status      JobStatus
    cost        Float
    startDate   DateTime?
    endDate     DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now()) @updatedAt

    createdByUserId Int
    createdBy       User @relation("JobCreatedBy", fields: [createdByUserId], references: [id])

    homeowners User[]    @relation("JobHomeowners")
    tasks      JobTask[]

    deletedAt       DateTime?
    deletedByUserId Int?
    deletedBy       User?     @relation("JobDeletedBy", fields: [deletedByUserId], references: [id])

    messages JobChatMessage[]

    @@index([createdByUserId, status])
    @@index([createdByUserId, startDate])
    @@index([createdByUserId, endDate])
    @@index([createdByUserId, createdAt])
    @@index([createdByUserId, updatedAt])
}

model JobChatMessage {
    id              Int      @id @default(autoincrement())
    jobId           Int
    job             Job      @relation(fields: [jobId], references: [id])
    content         String
    createdAt       DateTime @default(now())
    createdByUserId Int
    createdBy       User     @relation("JobChatMessageCreatedBy", fields: [createdByUserId], references: [id])
}

model JobTask {
    id                Int       @id @default(autoincrement())
    jobId             Int
    job               Job       @relation(fields: [jobId], references: [id])
    description       String
    cost              Float?
    completedAt       DateTime?
    completedByUserId Int?
    completedBy       User?     @relation("JobTaskCompletedBy", fields: [completedByUserId], references: [id])
}
